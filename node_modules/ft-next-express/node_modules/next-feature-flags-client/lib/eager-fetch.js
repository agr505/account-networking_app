'use strict';

var logger = require('ft-next-logger');
var catchNetworkErrors = function(err) {
	if (err.message.indexOf('network timeout at') > -1) {
		logger.warn('Fetch network error occurred', { message: err.message });
		return { ok: false };
	} else {
		throw err;
	}
};

module.exports = function(url, opts) {
	var retriesLeft = opts.retry || 3;
	opts.retry = undefined;

	function fetchAttempt() {
		return fetch(url, opts)
			.catch(catchNetworkErrors)
			.then(function(response) {
				if (!response.ok && retriesLeft > 0) {
					logger.info("Failed to fetch " + url + " but have " + retriesLeft + " remaining so retrying");
					retriesLeft--;
					return fetchAttempt();
				}
				return response;
			});
	}

	return fetchAttempt();
};
