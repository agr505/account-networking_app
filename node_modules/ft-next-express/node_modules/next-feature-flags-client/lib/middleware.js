/*jshint node:true*/
'use strict';

module.exports = flagsMiddleware;

var flagsClient = require('../server');
var toggler = require('./toggler');

function flagsMiddleware(req, res, next) {
	var rawOverrides;

	// When the app is served via Fastly the flags are accessible via a header
	if (req.header('X-Flags')) {
		rawOverrides = req.header('X-Flags');
	// Otherwise, if developing locally use cookies
	} else if (process.env.NODE_ENV !== 'production') {
		rawOverrides = toggler.readFromCookie(req.header('Cookie'));
	}

	res.locals.flags = toggler.override(flagsClient.getHash(), rawOverrides);
	res.locals.flagsArray = flagsClient.flagsArray;

	res.vary('X-Flags');
	next();
}
