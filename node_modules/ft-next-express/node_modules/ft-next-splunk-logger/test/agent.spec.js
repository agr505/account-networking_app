'use strict';
/*global describe, it, beforeEach, afterEach*/
var expect = require('chai').expect;
var fork = require('child_process').fork;
var path = require('path');
process.env.SPLUNK_URL = 'http://localhost:6666';
var http = require('http');

describe('Agent', function(){

	var agent, server;
	var promise;

	beforeEach(function(){
		var requestData = '';
		promise = new Promise(function(resolve){
			server = http.createServer(function(req, res){
				req.on('data', function(chunk) {
					requestData += chunk.toString();
				});
				req.on('end', function(){
					resolve(requestData);
				});
			});
			server.listen(6666);
			agent = fork(path.resolve(__dirname, '../src/agent.js'), {env:process.env, cwd:process.cwd()});
		});
	});

	afterEach(function(done){
		agent.kill();
		server.close(done);
	});

	it('Should listen for messages from the parent process and send them to splunk', function(done){
		var log = 'svdsvsdvdsvds';
		promise.then(function(data){
			expect(data).to.equal(log);
			done();
		}).catch(done);
		agent.send(log);
	});
});
